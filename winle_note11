思路准备
 
一、WIFI专项学习一（关于WLAN报文Qos优先级）
WLAN报文优先级Qos优先级是如何提升WIFI性能的
1．WMM（IEEE 802.11e）协议定义了四种WLAN QoS优先级
WMM定义了由高到低的四种优先级（AC）：Voice，Video，Best Effort，Back Ground
优先级不能保证（极限）吞吐率，更适合于时延等响应敏感的应用场景
注：音频 > 视频 > 尽力而为业务 > 背景业务（背景流）
尽力而为业务：一种传统的IP分组投递服务，其特点是按照报文到达时间的先后顺序采用先来先服务的原则处理报文的转发，所有用户的报文共同分享网络和路由器的带宽资源，至于得到资源的多少完全取决于报文到达的时间。Best Effort对分组投递的延迟、延迟抖动、丢包率和可靠性等需求不提供任何承诺和保证。
维基百科解释
Best Effort：来自传统设备的流量，或来自缺乏QoS能力的应用或设备的流量，流量对时延不敏感，但受时延大影响，如上网
Back Ground: 低优先级通信（文件下载、打印作业），对延迟和吞吐量要求不高
2.  WiFi高优先级为什么优？哪些场景会优
2.1 WiFi高优先级QoS的场景
	多业务场景内部优先调度：高优先级业务流具有独立的发送队列，不会被其他低优先级业务流由于FIFO（先入先出）规则阻塞
注：设备自身存在多种发送方向的业务流。（如：背景上网流量和视频通话业务）
	抗干扰吞吐量：高优先级的报文空口抢占
注：空口中存在其他STA的低优先级业务流，高优先级报文更优
	发送时延更优：空口等待时间；调度时间
注：竞争不存在时，也会有收益
2.2 独立的调度队列，不会受其他优先级干扰
 
图2.1 WiF驱动四个优先级发送队列
2.3 空口竞争优，花费更少时间发送到空口
下图说明了不同优先级在空口竞争中行为的差异（空口抢占的快慢），即：更容易更快的发送出WiFi网卡
注：EDCA模式下，从检测到空口空闲到实际抢占到空口前，会等待三段时间SIFS、AIFSN、Random Backoff。AIFSN和Random Backoff的定义详见“图AIFSN 和 Random Backoff的缺省定义”
 
图2.2 WMM优先抢占示例
2.4 收益评估场景
	单STA&多业务场景的高优先级业务的时延和吞吐率
	多STA（/ AP）空口场景的高优先级吞吐率和时延波动
	单STA&单业务场景高低优先级业务的时延对比
3. EDCA定义的四种优先级的空口竞争参数（详见专项学习二）
3.1 EDCA参数分类
 
这三个参数综合起来，达成高优先级报文（比低优先级报文平均起来）花费更少的时间来发送的效果。
TXOP（发送机会）内，STA能发送尽可能多的帧，知道发送时间大道最大TXOP时间。TXOP为0，表明发送最大时间限定到一个MSDU/MMPDU范围内。如果一个帧的发送时间超过TXOP，则需要分片成多个小帧。
3.2 EDCA缺省定义（11A/11N为例）	
 
 
图3.1 AIFSN和Random Backoff的缺省定义
每个AC有不同的仲裁帧间隙（Airation Inter-Frame Space） ，它进一步控制发送端在介质空闲后等待的时间。与此同时， EDCA也引入了细微的退避倒计时的变化。
 
3.3 如何查看EDCA
方法一：使用各芯片厂商的内部命令（部分高端路由器提供了WMM参数的配置页面）
busybox.suid su	# 命令行不一样，电信权限不一样
iwpriv vap4 alg "get_edca_param 0"
 
方法二、通过空口报文的WMM IE
WMM IE在以下三种管理帧中出现：
	Association requests (from Station)
	Beacons (from AP)
	Association responses (from AP)
 
参数算法解读
 
4、如何使用高优先级，让高优先级生效
让发送报文使用高优先级，有两种方法：IP头的DSCP映射，或者H内部修改SKB的Remark域
4.1 IEEE 802.11e协议定义802.1p DS域映射到WMM QoS的规则
IP报文到WLAN优先级的映射公式
IP_DifferentiatedService_Field_Value/(4*8) = 802.11 UP value   –> 802.11 AC category
802.11 UP value 与802.11 Access Category的映射关系
 
IP头部的DSCP域定义
 
4.2 代码如何生效
 
4.3 如何确认优先级生效
空口抓包查看本设备发出的Qos Data报文，Mac Header的Qos Control Field。如下图所示，报文的优先级为0: Best Effort.
注：WiFi Qos只影响本侧的Tx 数据报文，不影响管理帧和控制帧。 Rx报文的优先级，不影响本侧的接收行为。
 
5、WiFi优先级使用不当的案例
5.1、优先级实现的一些问题
	不同优先级的方案在聚合，RTS策略，EDCA参数方面有不同处理，建议咨询对应的WiFi芯片厂商。
	802.11N之后的协议才会生效，只影响本侧发送的数据业务
	优先级设定更重要的是获得时延收益，而不是极限场景下的吞吐量（跟师傅确认过，调度更关注吞吐量）
	EDCA修改太猛，影响通过法规认证，甚至被投诉
5.2、实际案例
1）游戏方案误用Voice优先级，造成干扰场景丢包严重。
   原因： 某WiFi芯片方案的Voice优先级报文发送，不发送RTS
2）航*所高优先级业务上网不通
原因： 直接修改了“外发”报文的DS值，该所的路由器对某些高优先级报文直接过滤丢弃。
注：“外发报文”指会发送到网络侧的报文。本地设备的投屏、文件share共享报文不属于此外发报文。
3）某B方案的路由器下行测速吞吐率只有~25Mbps
   原因：该方案对AC_BK（1）的报文采用不AMPDU聚合的策略
4）某方案的AC_VO业务流的极限吞吐率小于AC_BE
   原因：AC_VO为了争取高时延响应，聚合策略和聚合参数不同。
5）AP极限TCP吞吐率 与UDP相差过大。
原因：AP侧发送EDCA参数调节过于激进，造成STA对端的TCP ACK报文没有机会发出。
6) 某芯片的WMM认证无法通过。
   原因：TxOP设置过于激进，违反了WMM某用例。
7）某R芯片的路由器，在国外被投诉没有遵循WMM协议。
   原因：EDCA竞争窗口设置固定为协议规定的Content Window下限。
8) 未使能WMM，或者使用了TKIP加密方式，造成WiFi测速低，只有~25Mbps。
原因：11N/11AC需要WMM使能才能生效，否则会下降到11G模式的吞吐率。(注,一般WMM缺省使能)
 9) 某投屏方案, 把视频流修改成Voice优先级,造成在蓝牙共存场景出现卡顿. 
   原因：使用的产品芯片Voice没有聚合, 大流量的视频报文对空口占用过大, 在蓝牙共存场景出现空口瓶颈.
10) 某WiFiAP对通某手机,Tx/Rx同时发送,Tx很低, Rx很高. (类似#5)
原因: Ap的EDCA参数 弱于 手机, 抢不过手机.
 
二、WIFI专项学习二（关于802.11 EDCA）
1、EDCA机制详解
802.11p标准中采用IEEE 802.11e中的EDCA机制来解决当MSDU（MAC服务数据单元）到达MAC子层和适当的信道路由分配时，MAC层通过将它的用户级别（UP）映射到接入类型指数（ACI）来缓存此数据；而不同的接入类型（AC）通过设置不同的EDCA参数来体现优先级。
 
同上图2.1
802.11p采用多信道模式，每个设备都可以在控制信道和一个服务信道之间来回切换，但是同一时刻不能使用两个不同的信道。包含一个控制信道间隔时间和一个服务信道时间间隔时间的周期时间不能持续超过100ms，控制信道一般用于系统控制数据和安全性消息的传输，而非安全性消息只能在6个服务信道中进行交换。
 
图1.1 802.11p多信道机制
注：CCH：控制信道 
SCH：服务信道
CCH用于进行广播及发送安全相关消息，一般消息通过业务信道SCH发送（车联网）
传输信道是物理层提供给上层的服务接入点，上层如果需要物理层提供的服务，就只能通过传输信道来接入，同样，上层生成的数据也由映射到不同物理信道的传输信道在空中传输。传输信道分为公共传输信道和专用传输信道。其中，公共传输信道分为广播信道、前向接入信道、寻呼信道、公共分组信道和下行共享信道。
2、参数概述
标准提供的四种不同的访问类型(背景流、语音、视频、尽力而为的数据) 
•AC3: Voice traffic. 
•AC2: Video traffic. 
•AC1: Best effort traffic. 
•AC0: Background traffic
	可视为有四个随机退避的状态机，将这一对发送队列和与之对应的随机退避状态机称为一个虚拟内部站点QSTA，这样，每个QSTA内有4个虚拟内部站点，通过设置EDCA参数来竞争获得发送机会（TransmissionQpportunity TXOP）
 
每个QSTA中的访问类型AC都是基于上面四种参数独立的竞争，获得访问信道的机会
CWmin：最小竞争窗口，越小的CWmin其优先级越高；
CWmax：最大竞争窗口，越小的CWmax其优先级越高
TXOP：传输机会，参数值为TXOPlimit，代表占用信道最长时间（无竞争）
AIFS：EDCA模式的QSTA要获得传输机会时，必须等待的信道空闲时间。
 
注：参数缺省如专项学习一3.2所示
一旦某个AC侦测到无线媒介处于一个长为AIFS的空闲时间状态，它便启动如图2.1所示的退避规程，只有退避时间减为0的那个QSTA才有权发送数据帧；如果有多个AC的退避时间减至0，则来之高优先级AC将获得发送机会TXOP，开始发送相应的帧，而不发送来自较低优先级AC的帧。
 
图2.1 退避过程
3、 802.11p的EDCA参数集介绍
管理帧实体中包含了EDCA参数集，在基础型服务集中，AP发送给STA用以更新STA内EDCA相关的MIB属性值。
参数集的更新：WAVE工作模式，此时车辆节点在BSS之外通信时（此时dot11OCBEnabled 为1），车辆节点的EDCA参数采用默认的MIB属性值（此时TXOP limit=0）。车辆节点处在BSS中通信时，未接收到该BSS内AP发送的管理帧中的EDCA参数集，采用默认；否则用接收到的参数集修改自身EDCA参数。
 
上图，每个AC类别内都含有各自不同的参数，包括AIFSN、ECWmin/ECWmax、TXOP limit
3.1. TXOP limit
WAVE工作模式下，TXOP limit字段值为0，表示单个MSDU或MMPDU，除了可能的RTS / CTS交换或CTS本身之外，在每个TXOP传输机会下，可以以任何速率发送MSDU或MMPDU。 
注：在非WAVE工作模式中，TXOP Limit是一个无符号整数，32μs为一个单位。在TXOP Limit时间内，可以无竞争发送帧。在若剩下的时间不足以发送一个MSDU或MMPDU，则节点放弃传送，进入退避程序。
 
3.2. AIFS（Arbitration Inter Frame Space，仲裁帧间间隔）
功能：在DCF中，帧间间隔DIFS被用于衡量信道空闲DIFS时长后进入退避程序，采用EDCA机制的节点在检测信道空闲持续AIFS之后，节点进入退避程序。 
在DCF中，当发生一个帧被检测到但是没有被成功解调时，站点必须后延EIFS。 
此处可以分为两种情况： 
1、接收错误，此时物理层向MAC报告错误发生，发送原语PHYRXEND.indication； 
2、在解析MAC FSC中发现序列在传输中发生错误。
4、EDCA的退避机制
每个AC都维持着自己的CW[AC]窗口，在初始时候，CW[AC]等于CW[AC]min。
每当传送成功，单播接收到正确的ACK或者传送带有No Ack police的帧或者本就不需要ACK的组播帧，CW[AC]复位为CW[AC]min。
退避程序在以下时间发生时被唤醒：
a)	AC中有帧需要传送，且信道繁忙，且此时退避计时器为0.那么就要从退避窗口随机取值（此时退避窗口不变！！！），计算退避时长。
b)	获得传送机会TXOP的AC传送成功之后，也需要马上进入退避程序，此时CW[AC]复位为CW[AC]min。
c)	当该AC在获得TXOP传送机会后传送失败，即没有接收到ACK，（此时可以视为发生了外部竞争冲突）则需要进入退避程序
d)	在AC内部发生竞争冲突时，即两个AC同时退避窗口降为0时，优先级更高的获得发送权利。此时，优先级低的AC进入退避程序。（如果优先级相同呢？发送失败？）
当QSRC[AC]或者QLRC[AC]的计数到达dot11ShortRetryLimit或者dot11LongRetryLimit时，CW[AC]复位为CW[AC]min。
否则：
CW[AC]小于CW[AC]max时，CW[AC]=( CW[AC]+1)*2-1; 
CW[AC]等于CW[AC]max时，CW[AC]不变。 
注意：外部冲突发生时，MSDU的标志位retry需要变为1,但是内部冲突发生时retry标志位不变。 
所有的退避程序必须在检测到信道空闲持续 AIFS[AC] 之后才能进入退避程序。
5、EDCA的重传机制
QoS STAs为每一个MSDU、MMPDU维护着短帧重传计数器short retry counter以及长帧重传计数器long retry counter，其初始值都为0。同时，QoS STAs为每个AC都维护着QSRC[AC]和QLRC[AC]，初始值同样为0.【四个计数器】
注：这里的计数器分别针对帧和信道 
[外部] 在发送需要确认ACK的帧之后，站点进入ACK进程。（即一定时间内等待ACK的接收，若没有，则失败）
a. 发送失败， 
帧长度小于dot11RTSThreshold时，SRC加1，令QSRC[AC]=SRC 
帧长度大于dot11RTSThreshold时，LRC加1，令QLRC[AC]=LRC 
b. 发送成功，帧长度对应的计数器重置为0（针对信道和帧的计数器都要置0）

【内部】在内部发生冲突时，对应的QSRC[AC] 或者QLRC[AC]增加，直至其达到上限。
注意：重传的数据帧或者管理帧上的retry位要置为1. 
当任意计数器到达其上限，dot11ShortRetryLimit或者dot11LongRetryLimit时，MAC将丢弃该帧，重置SRC/QSRC[AC]或者LRC/QLRC[AC]
 
 
三、WiFi专项学习三（ns3仿真基本流程）
使用ns-3进行网络仿真时，一般经过一下4个步骤：
1、选择或开发相应模块
根据实际仿真对象和仿真场景选择相应的仿真模块。
如有限局域网络（CSMA）,无线局域网络（Wi-Fi）；
节点是否需要移动（mobility）；
使用何种应用程序（application）；
是否需要能量管理（energy）；
使用何种路由协议（Internet、aodv等）；
是否需要动画演示（visualizer、netanim）等；
如果搭建的网络比较新，就需要开发自己设计的协议。
2、编写网络仿真脚本：C++或者Python
编写脚本过程：
1）生成节点（如网卡、应用程序、协议栈等）
节点相当于一个空的计算机外壳，接下来要给计算机安装网络所需要的软硬件，如网卡、应用程序、协议栈等
2）安装网络设备（如CSMA、WiFi、wimax、point-to-point）
不同的网络类型有不同的网络设备，从而提供不同的信道、物理层和mac层
3）安装协议栈：ns-3一般是TCP/IP协议栈
依据网络选择具体协议（如udp还是tcp）、选择路由协议（olsr、aodv、global等）并为其配置ip地址
4）安装应用层协议
依据选择的传输层协议选择相应的应用层协议，有时需要自己编写应用层产生网络数据流量的代码。
5）其他配置（如节点是否要移动，是否要能量管理）
6）启动仿真
网络场景配置完成，启动仿真。
以上概念使网络节点实现了物理连接，要实现通信还需要软件支持，也就是协议，应用层产生数据，利用类socket编程实现数据分组的向下传递，数据分组通过协议栈tcp、ip向下传递给网络设备（可简单理解为网卡），该网络设备包括mac层物理层协议，于是数据分组就像在真实网络中流动一样，由数据帧转换成二进制流，最终变成信号通过媒体信道传输到目的节点。
目的节点收到数据分组后从下往上逐层转交，由媒体信号转换成二进制，二进制转换成数据帧，再转换成IP数据分组，然后经由传输层的端口号转交给相应进程。
3、仿真结果分析
仿真结果有两种：一种是网络场景，另外一种是网络数据。
网络场景，如节点拓扑结构、移动模型等，一般通过可视化界面（pyviz或netanim）可直观观察到
网络数据也可在可视化界面下有简单统计。此外可以通过专门的统计框架（status）或自行通过ns3提供的追追踪系统（tracing）收集、统计、分析相应的网络数据，如数据分组的延迟、网络流量、分组丢失了、节点消息缓存队列
4、依据仿真结果调整网络配置参数或修改源代码

 
四、WiFi专项学习四（多用户测试白皮书）
调度问题
	调度ATF多TID调度饿死 单用户多tid打流存在饿死现象
	RR多TID调度饿死算法进入到RR调度，如果高优先有业务，会饿死低优先级业务
	组播报文限速 通过调度对组播报文进行合理的限速

在高密度场景下，每个用户吞吐量很低的时候，11ax的吞吐量低于11ac(不用OFDMA，类似算法回退，在OFDMA的基础上进行算法优化)
原因：多用户场景下，station数量小于3，多用户传输的业务速率低造成资源浪费，需要更优的调度算法进行分配
1、SU多用户
	在SU调度策略中的WMM调度算法，参考了WMM协议的思想，针对不同AC类型的用户数据，具有不同的调度策略，参考了WMM协议的思想，针对不同AC类型的用户数据，具有不同的调度策略，基本思想是优先调度高优先级VO、VI等AC类型的数据。
调度算法的基本思路：
1)	首先保证每个周期内每个AC均调度一次
2)	VO业务采用轮询调度，若VO业务TID队列为空，则转ATF算法调度
3)	VI业务采用严格优先级调度：遍历所有的VI用户，优先调度权重大的用户，权重=速率*首包延时
4)	BE、BK存在非空的最小带宽令牌桶：如果存在，则调度最大令牌桶的用户，否则转（5）
5)	调度BE、BK速率最大的用户，最大化系统吞吐量
1.1、轮询调度
1.2、ATF调度
ATF（Airtime Fairness）空口占用时间公平性算法，应用在多用户的场景，主要目标是让每个user/vap/ac公平的使用空口时间，在多用户性能之间差异较大的时候，该方法相比轮询调度能获得更大的收益。其次可以主动改变某个user/ac/vap下的比例，来控制占用空口比例。
SSID粒度，也就是VAP级别的ATF，在调度时考虑VAP在空口的占用时间；
STA粒度，也就是User级别的ATF，在调度时会考虑所有VAP下的所有user在扣扣的占用时间
AC优先级，也就是TID级别的ATF，在调度时考虑所有VAP下的所有user下的所有TID的空口占用时间。
 
以User粒度为例，以固定的空口时间（如100ms）为粒度，按照比例预先分配给每个单元剩余时间。如上图所示为三个用户均分一个周期100ms，每个用户可以获得大致约33ms的空口传输时间，每个用户获得的传输时间会被分为多次使用，每个用户每次发送完成从剩余时间扣除本次发送时间，当剩余时间扣除至0，则本轮不再调度。当所有单元的剩余时间都用完后则重新分配剩余时间进行新一轮的调度，每次调度选择最大剩余时间的用户。
整个ATF调度的过程和轮询调度类似，每次直接调度有数据的AC链表头部，TID链表头部的用户id，并将调度的AC、TID以及用户id再插入至链表尾部，以此类推。
扣除每次发送占用的空口时间意义为本次txop的时间，用于刷新以及记录用户的剩余时间，可以通过device描述符中硬件上报的两个时间进行计算使用： 
 
空口时间(us) = tx_done_timestamp – backoff_done_timestamp。
五、WiFi专项学习五（名词解析）
1、VAP
虚拟接入点VAP（Virtual Access Point）：VAP就是在一个物理实体AP上虚拟出多个AP，每一个被虚拟出的AP就是一个VAP，每个VAP提供和物理实体AP一样的功能。用户可以在一个AP上创建不同的VAP来为不同的用户群体提供无线接入服务。
VAP类型根据其功能分为以下几类
业务型VAP：用于WLAN无线业务，供无线用户访问网络
WDS型VAP：用于WDS无线建链，供无线业务回传
Mesh型VAP：用于Mesh无线建链，供无线业务回传
管理AP型VAP：顾名思义，这个类型的VAP可以通过无线用户登录到AP上对AP管理
业务型VAP和管理AP型VAP
WLAN网络中，AP是为STA提供的WLAN业务功能实体，虚拟出来的VAP可以无线业务覆盖，提供无线信号供用户访问WLAN网络P，如图1-1中的VAP0
同时虚拟出来的VAP也可以用于管理AP设备，无线用户可以通过无线网络Telnet到AP上，如图中的VAP1
 
WDS型VAP
WDS网络中，AP是为邻居设备提供WDS服务的功能实体，虚拟出来的VAP可以用于相邻的AP之间建立WDS链路，如图1-2中的VAP12和VAP13，AP_1的VAP12和AP_2的VAP13之间建立一条WDS无线虚拟链路，AP_2的VAP12和AP_3的VAP13建立一条WDS无线虚拟链路。
  
Mesh型VAP
Mesh网络中，通过无线Mesh链路将多个AP连接起来，最后通过Mesh节点接入有线网络，组成一种星型动态自组织自配置的无线网络，AP虚拟出来的VAP可以用于相邻的AP之间建立Mesh链路，如图1-3中的VAP15，AP_1的VAP15和AP_2的VAP15之间建立一条Mesh链路，AP_2的VAP15和AP_3的VAP15建立一条Mesh无线虚拟链路。
 
四种VAP类型之间的区别
 
2、QoS令牌桶
2.1、缩略语
 
2.2、基本工作原理
 

 
文献相关（待看）
 
 
 
 
